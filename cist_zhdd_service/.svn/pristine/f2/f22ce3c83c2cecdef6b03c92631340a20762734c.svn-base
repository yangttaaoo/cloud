package com.cist.eventmanagement.controller;

import java.io.BufferedInputStream;
import java.io.BufferedOutputStream;
import java.io.ByteArrayOutputStream;
import java.io.DataOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.HttpURLConnection;
import java.net.URL;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.zip.ZipEntry;
import java.util.zip.ZipOutputStream;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.cist.eventmanagement.model.DeptInfo;
import com.cist.eventmanagement.model.VW_EVENT_INFO;
import com.cist.eventmanagement.service.EventManagementService;
import com.cist.eventmanagement.util.UrlFilesToZip;
import com.cist.frame.page.PageInfo;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
@RestController
@SuppressWarnings("unchecked")
@RequestMapping("/event")
public class EventManagementController {
	@Autowired
	private EventManagementService service;
	
	/**
	 * 分页查询事件详细信息
	 * @param map
	 * @param request
	 * @return
	 */
	@RequestMapping("queryevent")
	public PageInfo<VW_EVENT_INFO> queryevent(@RequestBody HashMap<String, Object> map,HttpServletRequest request){
		PageInfo info = new PageInfo();
		info.setPageNum(Integer.parseInt(map.get("currentPage").toString()));
		info.setPageSize(Integer.parseInt(map.get("pageSize").toString()));
		PageInfo<VW_EVENT_INFO> pageinfo = (PageInfo<VW_EVENT_INFO>)service.queryeventinfopageList(map, info);
		return pageinfo;
	}
	/**
	 * 删除事件信息
	 * @param map
	 * @param request
	 * @return
	 */
	@RequestMapping("delete")
	public Integer deleteevent(@RequestBody HashMap<String, Object> map,HttpServletRequest request) {
		try {
			service.deleteeventinfo(map);
			service.delZhdd_event_acceptance(map);
			return 1;
		} catch (Exception e) {
			return 2;
		}
		
	}
	
	/**
	 * 更新事件信息
	 * @param map
	 * @param request
	 * @return
	 */
	@RequestMapping("update")
	public Integer updateevent(@RequestBody HashMap<String, Object> map,HttpServletRequest request) {
		try {
			service.updateeventinfo(map);
			return 1;
		} catch (Exception e) {
			return 2;
		}
		
	}
	/**
	 * 部门树
	 * 
	 * @return
	 * @throws JsonProcessingException
	 */
	@RequestMapping("deptinfo")
	public String deptinfo() throws JsonProcessingException {
		// 顶级部门
		List<DeptInfo> departinfo = service.depart_infolist(null);
		ObjectMapper mapper = new ObjectMapper();
		List<DeptInfo> list = departinfodg(departinfo);
		String json = mapper.writeValueAsString(getdiwfdidian(list));
		return json.substring(1, json.length() - 1);
	}

	public List<HashMap<String, Object>> getdiwfdidian(List<DeptInfo> list) {
		List<HashMap<String, Object>> listmap = new ArrayList<HashMap<String, Object>>();
		for (DeptInfo depart_info : list) {
			HashMap<String, Object> map = new HashMap<String, Object>();
			map.put("title", depart_info.getName());
			map.put("key", depart_info.getDept_pk());
			map.put("selectable", depart_info.getSelectable());
			map.put("isLeaf", depart_info.getIsLeaf());
			if (null != depart_info.getChildren()) {// 下级
				map.put("children", getdiwfdidian(depart_info.getChildren()));
				listmap.add(map);
			} else {
				listmap.add(map);
			}
		}
		return listmap;
	}

	public List<DeptInfo> departinfodg(List<DeptInfo> departinfo) {
		for (DeptInfo depart_info : departinfo) {
			// 部门
			List<DeptInfo> list = service.depart_infolist(depart_info.getDept_pk());
			if (list.size() != 0) {
				depart_info.setChildren(list);
				departinfodg(list);
			}
		}
		return departinfo;
	}
	/**
	 * 添加页面加载时查询事件类型和事件来源信息
	 * @param map
	 * @return
	 */
	@RequestMapping("addindex")
	public HashMap<String,Object> addindex(@RequestBody HashMap<String,Object> map){
		HashMap<String,Object> ModelMap = new HashMap<String,Object>();
		ModelMap.put("sjly", service.querysjly(null));
		ModelMap.put("sjtype", service.querysjtype(null));
		ModelMap.put("yxx", service.queryyxx(null));
		return ModelMap;
		}
	/**
	 * 事件添加
	 * @param map
	 * @return
	 */
	@RequestMapping("add")
	public Integer addsj(@RequestBody HashMap<String,Object> map){
		try {
			map.put("event_current_status", 4);
			map.put("event_status", 0);
			service.addsj(map);
			service.addslinfo(map);
			return 1;
		} catch (Exception e) {
			return 2;
		}
	}
	/**
	 * 查询事件详细信息
	 */
	@RequestMapping("querysjinfo")
	public HashMap<String,Object> querysjinfo(@RequestBody HashMap<String,Object> map){
		HashMap<String,Object> ModelMap = new HashMap<String,Object>();
		ModelMap.put("ddinfo", service.queryddinfo(map));//根据事件id查询调度信息
		ModelMap.put("slinfo", service.queryslinfo(map));//根据事件id查询受理信息
		ModelMap.put("lcinfo", service.querylcinfo(map));//根据事件id查询事件处置流程信息
		ModelMap.put("yxx", service.queryyxx(null));//查询预选项信息
		ModelMap.put("people", service.querypeople(map));//查询事件处置人员信息
		ModelMap.put("sjfj", service.querysjfj(map));//根据事件id查询事件附件信息
		ModelMap.put("hfjg", service.querysjjg(map));//根据事件id查询事件处置结果
		return ModelMap;
	}
	
	/**
	 * 根据事件id查询受理信息
	 * @param map
	 * @return
	 */
	@RequestMapping("queryslinfobysjid")
	public HashMap<String,Object> queryslinfobysjid(@RequestBody HashMap<String,Object> map){
		HashMap<String,Object> ModelMap = new HashMap<String,Object>();
		ModelMap.put("slinfo", service.queryslinfo(map));//根据事件id查询受理信息
		return ModelMap;
	}

	/**
	 * 更新事件信息
	 * @param map
	 * @return
	 */
	@RequestMapping("updateevent")
	public Integer updateeventinfo(@RequestBody HashMap<String,Object> map){
		try {
			service.updateZhdd_event_information(map);
			service.updateZhdd_event_acceptance(map);
			return 1;
		} catch (Exception e) {
			return 2;
		}
		
	}
	
	
	/**
	 * 下载
	 * @param map
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	@RequestMapping("download")
	public void downloadFiles(@RequestBody HashMap<String, Object> map, HttpServletRequest request,
			HttpServletResponse response) {
		Map<String, String> urlByLoanid= new HashMap<String,String>();
		try {
			String attachment_source = map.get("attachment_source").toString();//附件路径
			String fileName=map.get("attachment_name").toString();//附件名称
			URL url = new URL(attachment_source);
			HttpURLConnection conn = (HttpURLConnection)url.openConnection();
			//设置超时间为3秒  
			conn.setConnectTimeout(3*1000);
			//防止屏蔽程序抓取而返回403错误  
			conn.setRequestProperty("User-Agent", "Mozilla/4.0 (compatible; MSIE 5.0; Windows NT; DigExt)");
			//得到输入流  
			InputStream inputStream = conn.getInputStream();
			//获取自己数组  
			byte[] bs = readInputStream(inputStream); 
			response.setContentType("application/octet-stream;charset=ISO8859-1");
			BufferedOutputStream output = null;
			BufferedInputStream input = null;
			try {
				output = new BufferedOutputStream(response.getOutputStream());
				// 中文文件名必须转码为 ISO8859-1,否则为乱码
				String fileNameDown = new String(fileName.getBytes(), "ISO8859-1");
				// 作为附件下载
				response.setHeader("Content-Disposition", "attachment;filename=" + fileNameDown);
				output.write(bs);
				response.flushBuffer();
				
			} catch (Exception e) {
				System.err.println("Download log file error"+"----"+e.getMessage());// 用户可能取消了下载
			}finally{
				if (input != null)
					try {
						input.close();
					} catch (IOException e) {
						e.printStackTrace();
					}
				if (output != null)
					try {
						output.close();
					} catch (IOException e) {
						e.printStackTrace();
					}
			}
			
			
		} catch (Exception e) {
			
		}
	}


	/**
	 * 从输入流中获取字节数组
	 * @param inputstream
	 * @return
	 * @throws IOException
	 */
	public static byte[] readInputStream(InputStream inputstream) throws IOException{
		byte[] buffer = new byte[1024];
		int len = 0;
		ByteArrayOutputStream bos = new ByteArrayOutputStream();
		while((len = inputstream.read(buffer)) != -1) {
			bos.write(buffer, 0, len);
			}
		bos.close();
		return bos.toByteArray();
		}
	
	
}