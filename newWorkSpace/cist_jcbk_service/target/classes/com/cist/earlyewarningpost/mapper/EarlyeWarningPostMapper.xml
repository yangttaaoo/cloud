<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper
	namespace="com.cist.earlyewarningpost.mapper.EarlyeWarningPostMapper">


	<select id="list"
		resultType="com.cist.earlyewarningpost.model.JcbkWarningVehicle"
		parameterType="java.util.HashMap">
		select * from VW_JCBK_WARNING_VEHICLE
		<where>
			<if
				test="event_current_status !=null and event_current_status !=''">
				event_current_status=#{event_current_status}
			</if>
			<if test="bumenpk !=null and bumenpk.size()>0">
				and ssbm in
				<foreach collection="bumenpk" index="index" item="item"
					open="(" separator="," close=")">
					#{item}
				</foreach>

			</if>
		</where>
	</select>

	<select id="selectList"
		resultType="com.cist.earlyewarningpost.model.JcbkWarningVehicle"
		parameterType="java.util.HashMap">
		select * from VW_JCBK_WARNING_VEHICLE
		<where>
			<if
				test="event_current_status !=null and event_current_status !=''">
				and event_current_status=#{event_current_status}
			</if>
			<if test="hphm !=null and hphm !=''">
				and hphm like '%'||#{hphm}||'%'
			</if>
			<if test="hpzl !=null and hpzl !=''">
				and hpzl=#{hpzl}
			</if>
			<if test="yjdd !=null and yjdd !=''">
				and yjdd=#{yjdd}
			</if>
			<if test="ssbm !=null and ssbm !=''">
				and ssbm=#{ssbm}
			</if>
			<if test="yjlx !=null and yjlx !=''">
				and yjlx=#{yjlx}
			</if>
			<if test="kssj !=null and kssj !=''">
				 <![CDATA[and yjsj >= to_date(#{kssj},'yyyy-mm-dd HH24:mi:ss') ]]>
			</if>
			<if test="jssj !=null and jssj !=''">
				 <![CDATA[and yjsj <= to_date(#{jssj},'yyyy-mm-dd HH24:mi:ss') ]]>
			</if>
			<if test="yjddList !=null and yjddList.size()>0">
				and kkbh in
				<foreach collection="yjddList" index="index" item="item"
					open="(" separator="," close=")">
					#{item}
				</foreach>

			</if>
		</where>
	</select>

	<select id="selectYsl"
		resultType="com.cist.earlyewarningpost.model.JcbkWarningVehicle"
		parameterType="java.util.HashMap">
		select * from VW_JCBK_WARNING_VEHICLE
		where
		event_current_status !='0'
		<if test="bumenpk !=null and bumenpk.size()>0">
			and ssbm in
			<foreach collection="bumenpk" index="index" item="item"
				open="(" separator="," close=")">
				#{item}
			</foreach>

		</if>
	</select>

<!--警员信息查询  -->
	<select id="gpsRecordList"
		resultType="com.cist.earlyewarningpost.model.GpsRecord">
		<!-- select * from QW_GPS_RECORD t -->
		<!-- ( select RYFL from JCSJ_POLICE_RES_PERSON c where
		c.rybh=t.ywbh) as jytype -->
		select t.*,t1.ryfl as jytype,t1.xm,t1.id,t1.rybh from VW_QW_GPS_RECORD t left join JCSJ_POLICE_RES_PERSON t1 on t.ywbh = t1.rybh
	</select>

<!-- 设备信息列表 -->
	<select id="DeviceList"
		resultType="com.cist.earlyewarningpost.model.JcbkControlBayonet">
		select t.*,t2.device_gb_serial,t2.device_gb_code,t2.device_gb_channel from JCBK_CONTROL_BAYONET t
		
		left join JCSJ_DEVICE t1 on t.kkbh = t1.DEVICE_NUM
		left join JCSJ_DEVICE_CAMERA_GB28181 t2 on  t2.DEVICE_ID=t1.pk_id
		where t.ENABLE ='1'
		
	</select>
	
<!--查询警员信息 -->
	<select id="Jcsjpoliceresperson"
		resultType="com.cist.earlyewarningpost.model.Jcsj_police_res_person">
		select
		(select dept_name from SYS_DEPART_INFO where
		dept_code=c.GLBM) as
		fk_dept_name,
		(select fc_name from SYS_FRM_CODE
		where fct_code='JW06' and fc_code=c.zw) as
		car_brandname,
		(select
		fc_name from SYS_FRM_CODE where fct_code='JW04' and fc_code=c.YWGW)
		as
		ywgwname,
		(select fc_name from SYS_FRM_CODE where fct_code='SY01' and
		fc_code=c.XB) as
		xbname,
		c.* from JCSJ_POLICE_RES_PERSON c where
		c.rybh=#{device_code}
	</select>

	<select id="jcsjpolice_resperson"
		resultType="com.cist.earlyewarningpost.model.Jcsj_police_resources">
		select (select c.dept_name from SYS_DEPART_INFO c where
		c.dept_pk=t.fk_dept_id) as fk_dept_name,
		(select p.sypi_name from
		SYS_POLICE_INFO p where p.sypi_pk=t.create_person)
		as
		create_personname,
		(select fc_name from SYS_FRM_CODE where
		fct_code='C110' and
		fc_code=t.car_brand) as car_brandname,
		(select
		fc_name from SYS_FRM_CODE where fct_code='JW02' and
		fc_code=t.CAR_PURPOSE) as car_purposename,
		(select fc_name from
		SYS_FRM_CODE where fct_code='C002' and
		fc_code=t.car_type) as
		car_typename
		,t.* from JCSJ_POLICE_RESOURCES t where t.pk_id=(select
		d.pk_id from
		VW_PR_CAR_GPS d where d.device_code=#{device_code})
	</select>

<!-- 布控卡口拦截单位  单位关联区域 -->
	<select id="selectDeptArrea"
		resultType="com.cist.earlyewarningpost.model.SysDepartInfo">
		select * from SYS_DEPART_INFO s where
		s.dept_code in(select
		t.bmdm from JCBK_BAYONET_UNITS t where t.kkbh=#{kkbh})
	</select>

	<select id="depart_infolist"
		resultType="com.cist.earlyewarningpost.model.Depart_info"
		parameterType="java.lang.Integer">
		select t.dept_pk,t.dept_code,t.dept_name as name,t.DEPT_SUPERIOR from
		sys_depart_info t
		<where>
			<if test="_parameter  == null or _parameter  == ''">
				t.DEPT_SUPERIOR is null
			</if>
			<if test="_parameter  != null and _parameter  != ''">
				t.DEPT_SUPERIOR=#{_parameter}
			</if>
		</where>
	</select>
	<select id="selectPoliceList" parameterType="java.util.HashMap"
		resultType="com.cist.earlyewarningpost.model.Jcsj_police_res_person">
		select * from JCSJ_POLICE_RES_PERSON
		<where>
			<if test="Pleasevalue !=null and Pleasevalue.size()>0">
				and glbm in
				(select glbm from JCBK_FENCE_AREA t
				where exists(select BKKK from JCBK_BAYONET_AREA t1  where t1.QYPK = t.PK and t1.KKBH = #{kkbh}))
				<!-- (select bmdm from JCBK_BAYONET_UNITS where kkbh=#{kkbh}) -->
				<!-- <foreach collection="Pleasevalue" index="index" item="item"
					open="(" separator="," close=")">
					#{item}
				</foreach> -->

			</if>
			<if test="xm !=null and xm != ''">
				and xm like '%'||#{xm}||'%'

			</if>
		</where>
	</select>
<!-- 基础信息查询 -->
	<select id="selectBaseData" parameterType="java.util.HashMap"
		resultType="com.cist.earlyewarningpost.model.Sys_frm_code">
		select * from Sys_FRM_CODE
		where FCT_CODE=#{fct_code}
	</select>
	
	<!-- 布控卡口信息查询 -->
	<select id="selectBkkk" parameterType="java.util.HashMap"
		resultType="com.cist.earlyewarningpost.model.JcbkControlBayonet">
		select * from JCBK_CONTROL_BAYONET
	</select>

	<update id="update" parameterType="java.util.HashMap">
		update JCBK_WARNING_VEHICLE T
		<trim prefix="set" suffixOverrides=",">
			<if test="hphm != null and hphm !='' ">
				hphm=#{hphm},
			</if>
			<if test="hpzl != null and hpzl !='' ">
				hpzl=#{hpzl},
			</if>
			<if test="yjdd != null and yjdd !='' ">
				yjdd=#{yjdd},
			</if>
			<if test="cdfx != null and cdfx !='' ">
				cdfx=#{cdfx},
			</if>
			<if
				test="event_current_status != null and event_current_status !='' ">
				event_current_status=#{event_current_status},
			</if>
		</trim>
		where pk=#{pk}
	</update>
	<!--受理信息插入 -->
	<insert id="insertAccept">
		insert into JCBK_WARNING_ACCEPTANCE
		<trim prefix="(" suffixOverrides="," suffix=")">
			PK_ID,
			fk_warning_id,
			fk_acceptance_dept_id,
			fk_acceptance_person_id,
			acceptance_time,
			acceptance_state,
			<if test="wxyy !=null and wxyy !=''">
				wxyy,
			</if>
			<if test="fk_forward_dept_id !=null and fk_forward_dept_id !=''">
				fk_forward_dept_id,
			</if>
			<if test="fk_forward_dept_id !=null and fk_forward_dept_id !=''">
				forward_time,
			</if>

		</trim>
		<trim prefix="values(" suffixOverrides="," suffix=")">
			SEQ_JCBK_WARNING_ACCEPTANCE.NEXTVAL,
			#{fk_warning_id},
			#{fk_acceptance_dept_id},
			#{fk_acceptance_person_id},
			sysdate,
			#{acceptance_state},
			<if test="wxyy !=null and wxyy !=''">
				#{wxyy},
			</if>
			<if test="fk_forward_dept_id !=null and fk_forward_dept_id !=''">
				#{fk_forward_dept_id},
			</if>
			<if test="fk_forward_dept_id !=null and fk_forward_dept_id !=''">
				sysdate,
			</if>
		</trim>
	</insert>

	<!--调度的处置人员信息插入 -->
	<insert id="insertPersonnel">
		insert into JCBK_WARNING_PERSONNEL
		<trim prefix="(" suffixOverrides="," suffix=")">
			PK_ID,
			fk_warning_id,
			fk_warning_dispatch_id,
			fk_person_id,

		</trim>
		select cistsys.SEQ_JCBK_WARNING_PERSONNEL.NEXTVAL, cd.* from(
		<foreach item="item" index="index" collection="checkList"
			separator="union all">
			SELECT
			<trim suffixOverrides=",">
				#{fk_warning_id},
				#{fk_warning_dispatch_id},
				#{item.id},
			</trim>

			FROM DUAL
		</foreach>
		)cd
	</insert>
	<!--调度信息插入 -->
	<insert id="insertDispatch">
		<selectKey keyProperty="fk_warning_dispatch_id"
			resultType="java.lang.Integer" order="BEFORE">
			select cistsys.SEQ_JCBK_WARNING_DISPATCH.nextval as fk_warning_dispatch_id
			from dual
		</selectKey>
		insert into JCBK_WARNING_DISPATCH
		<trim prefix="(" suffixOverrides="," suffix=")">
			PK_ID,
			fk_warning_id,
			fk_dispatch_person_id,
			dispatch_time,
			<if
				test="notification_content !=null and notification_content !=''">
				notification_content,
			</if>
		</trim>
		<trim prefix="values(" suffixOverrides="," suffix=")">
			#{fk_warning_dispatch_id},
			#{fk_warning_id},
			#{fk_acceptance_person_id},
			sysdate,
			<if
				test="notification_content !=null and notification_content !=''">
				notification_content,
			</if>
		</trim>
	</insert>

	<select id="selectLj"
		resultType="com.cist.earlyewarningpost.model.JcbkBayonetUnits"
		parameterType="java.util.HashMap">
		select * from JCBK_BAYONET_UNITS
		where KKBH=#{kkbh}
	</select>

	<!--反馈信息保存附件 -->
	<insert id="savePic" parameterType="java.util.HashMap">
		insert into JCBK_WARNING_ATTACHMENT
		<trim prefix="(" suffixOverrides="," suffix=")">
			pk_id,
			fk_warning_id,
			attachment_name,
			attachment_suffix,
			attachment_size,
			attachment_source,
			commit_time,
			remarks
		</trim>

		select cistsys.SEQ_JCBK_WARNING_ATTACHMENT.nextval,cd.* from(
		<foreach item="item" index="index" collection="list"
			separator="union all">
			SELECT
			#{fk_warning_id},
			#{item.attachment_name},
			#{item.attachment_suffix},
			#{item.attachment_size},
			#{item.attachment_source},
			sysdate,
			#{item.remarks,jdbcType=VARCHAR}
			FROM DUAL
		</foreach>
		)cd
	</insert>
	<!-- 删除附件信息 -->
	<delete id="deletePic" parameterType="java.util.HashMap">

		delete from JCBK_WARNING_ATTACHMENT t
		where pk_id in
		<foreach collection="deletePic" index="index" item="item"
			open="(" separator="," close=")">
			#{item}
		</foreach>
		and t.FK_WARNING_ID=#{pk}
	</delete>


	<!--预警反馈内容 -->
	<insert id="insertFeedBack">
		insert into JCBK_WARNING_FEEDBACK
		<trim prefix="(" suffixOverrides="," suffix=")">
			PK_ID,
			fk_warning_id,
			<if test="disposal_location !=null and disposal_location !=''">
				disposal_location,
			</if>
			<if test="longitude !=null and longitude !=''">
				longitude,
			</if>
			<if test="latitude !=null and latitude !=''">
				latitude,
			</if>
			<if
				test="has_intercept_vehicles !=null and has_intercept_vehicles !=''">
				has_intercept_vehicles,
			</if>
			<if
				test="not_intercepted_reason !=null and not_intercepted_reason !=''">
				not_intercepted_reason,
			</if>
			<if
				test="has_suspected_vehicle !=null and has_suspected_vehicle !=''">
				has_suspected_vehicle,
			</if>
			<if
				test="not_suspected_vehicle_reason !=null and not_suspected_vehicle_reason !=''">
				not_suspected_vehicle_reason,
			</if>
			<if test="suspect_type !=null and suspect_type !=''">
				suspect_type,
			</if>
			<if test="exception_type !=null and exception_type !=''">
				exception_type,
			</if>
			<if test="transfer_dept_id !=null and transfer_dept_id !=''">
				transfer_dept_id,
			</if>
			<if test="contacts !=null and contacts !=''">
				contacts,
			</if>
			<if test="contact_number !=null and contact_number !=''">
				contact_number,
			</if>
			<if
				test="disposal_description !=null and disposal_description !=''">
				disposal_description,
			</if>
				feedback_person_id,
						<if
				test="fkbmdm !=null and fkbmdm !=''">
				fkbmdm,
			</if>

			feedback_time,
		</trim>
		<trim prefix="values(" suffixOverrides="," suffix=")">
			SEQ_JCBK_WARNING_FEEDBACK.NEXTVAL,
			#{fk_warning_id},
			<if test="disposal_location !=null and disposal_location !=''">
				#{disposal_location},
			</if>
			<if test="longitude !=null and longitude !=''">
				#{longitude},
			</if>
			<if test="latitude !=null and latitude !=''">
				#{latitude},
			</if>
			<if
				test="has_intercept_vehicles !=null and has_intercept_vehicles !=''">
				#{has_intercept_vehicles},
			</if>
			<if
				test="not_intercepted_reason !=null and not_intercepted_reason !=''">
				#{not_intercepted_reason},
			</if>
			<if
				test="has_suspected_vehicle !=null and has_suspected_vehicle !=''">
				#{has_suspected_vehicle},
			</if>
			<if
				test="not_suspected_vehicle_reason !=null and not_suspected_vehicle_reason !=''">
				#{not_suspected_vehicle_reason},
			</if>
			<if test="suspect_type !=null and suspect_type !=''">
				#{suspect_type},
			</if>
			<if test="exception_type !=null and exception_type !=''">
				#{exception_type},
			</if>
			<if test="transfer_dept_id !=null and transfer_dept_id !=''">
				#{transfer_dept_id},
			</if>
			<if test="contacts !=null and contacts !=''">
				#{contacts},
			</if>
			<if test="contact_number !=null and contact_number !=''">
				#{contact_number},
			</if>
			<if
				test="disposal_description !=null and disposal_description !=''">
				#{disposal_description},
			</if>
			<choose>
			<when test="feedback_person_id !=null and feedback_person_id != ''">
			#{feedback_person_id},
			</when>
			<otherwise>
			#{fk_acceptance_person_id},
			</otherwise>
			</choose>
			<if
				test="fkbmdm !=null and fkbmdm !=''">
				#{fkbmdm},
			</if>
			to_date(#{feedback_time},'yyyy-mm-dd HH24:mi:ss')

		</trim>
	</insert>
	<!--预警流程 受理信息查询 -->
	<select id="selectAcceptance"
		resultType="com.cist.earlyewarningpost.model.JcbkWarningAcceptance"
		parameterType="java.util.HashMap">
		select t.*,t1.sypi_name from JCBK_WARNING_ACCEPTANCE t

		left join SYS_POLICE_INFO t1 on t.FK_ACCEPTANCE_PERSON_ID=t1.sypi_pk
		where t.FK_WARNING_ID =#{pk}
	</select>

	<!--预警流程 反馈信息查询 -->
	<select id="selectFeedBack"
		resultType="com.cist.earlyewarningpost.model.JcbkWarningFeedBack"
		parameterType="java.util.HashMap">
		select t.*,t1.sypi_name from JCBK_WARNING_FEEDBACK t
		left join SYS_POLICE_INFO t1 on t.feedback_person_id=t1.sypi_pk
		where
		t.FK_WARNING_ID =#{pk}
	</select>

	<!--预警流程 处置结果信息 -->
	<select id="selectResult"
		resultType="com.cist.earlyewarningpost.model.JcbkWarningResult"
		parameterType="java.util.HashMap">
		select t.* from JCBK_WARNING_RESULT t
		where
		t.FK_WARNING_ID =#{pk}
	</select>

	<!--预警流程 处理文书 -->
	<select id="selectDocument"
		resultType="com.cist.earlyewarningpost.model.JcbkWarningDocument"
		parameterType="java.util.HashMap">
		select t.* from JCBK_WARNING_DOCUMENT t
		where
		t.FK_WARNING_ID =#{pk}
	</select>

	<!--预警流程调度信息查询 -->
	<select id="selectDispatch"
		resultType="com.cist.earlyewarningpost.model.JcbkWarningDispatch"
		parameterType="java.util.HashMap">
		select t.*,t1.sypi_name from JCBK_WARNING_DISPATCH t

		left join SYS_POLICE_INFO t1 on t.FK_DISPATCH_PERSON_ID=t1.sypi_pk

		where t.FK_WARNING_ID =#{pk}
	</select>

	<!--预警流程 反馈附件信息 -->
	<select id="selectAttachment"
		resultType="com.cist.earlyewarningpost.model.JcbkWarningAttachment"
		parameterType="java.util.HashMap">
		select t.* from JCBK_WARNING_ATTACHMENT t

		where t.FK_WARNING_ID =#{pk}
	</select>

	<!--预警流程 反馈信息查询 -->
	<!-- <select id="selectDispatch" resultType="com.cist.earlyewarningpost.model.JcbkWarningDispatch" 
		parameterType="java.util.HashMap"> select t.*,t1.sypi_name from JCBK_WARNING_DISPATCH 
		t left join SYS_POLICE_INFO t1 on t.FK_DISPATCH_PERSON_ID=t1.sypi_pk where 
		t.FK_WARNING_ID =#{pk} </select> -->

	<!--处理结果 -->
	<insert id="insertResult">
		insert into JCBK_WARNING_RESULT

		<trim prefix="(" suffixOverrides="," suffix=")">
			PK_ID,
			fk_warning_id,
			result_code,
		</trim>

		select cistsys.SEQ_JCBK_WARNING_RESULT.nextval,cd.* from(
		<foreach item="item" index="index" collection="cljgList"
			separator="union all">
			SELECT
			#{fk_warning_id},
			#{item}
			FROM DUAL
		</foreach>
		)cd
	</insert>

	<!--预警处理文书 -->
	<insert id="insertDocument">
		insert into JCBK_WARNING_DOCUMENT

		<trim prefix="(" suffixOverrides="," suffix=")">
			PK_ID,
			fk_warning_id,
			document_category,
			document_num,
			parity_bit,
		</trim>

		select cistsys.SEQ_JCBK_WARNING_DOCUMENT.nextval,cd.* from(
		<foreach item="item" index="index" collection="wenshuList"
			separator="union all">
			SELECT

			#{fk_warning_id},
			#{item.document_category},
			#{item.document_num},
			#{item.parity_bit}
			FROM DUAL
		</foreach>
		)cd
	</insert>

<!--车辆轨迹信息查询  -->
<select id="selectTrajectory"
		resultType="com.cist.earlyewarningpost.model.TblCarRecoInfo"
		parameterType="java.util.HashMap">
		select t.* from BSUSER.JCBK_CAR_RECO t
		<!-- left join JCSJ_DEVICE t1 on t.sbbh=t1.DEVICE_NUM -->
		<where>
			<if test="kssj !=null and kssj !=''">
				 <![CDATA[and jgsj >= to_date(#{kssj},'yyyy-mm-dd HH24:mi:ss') ]]>
			</if>
			<if test="jssj !=null and jssj !=''">
				 <![CDATA[and jgsj <= to_date(#{jssj},'yyyy-mm-dd HH24:mi:ss') ]]>
			</if>
			<if test="hphm !=null and hphm !=''">
				 and hphm = #{hphm}
			</if>
			<if test="gzsj !=null and gzsj !=''">
				 <![CDATA[and jgsj >= to_date(#{gzsj},'yyyy-mm-dd HH24:mi:ss') ]]>
			</if>
		</where>
		order by jgsj ASC
	</select>
	
	<!--查询警员信息  -->
<select id="selectPolice"
		resultType="com.cist.earlyewarningpost.model.Jcsj_police_res_person"
		parameterType="java.util.HashMap">
		select t.* from JCSJ_POLICE_RES_PERSON t
         where t.glbm=#{glbm}
	</select>


	<!-- 查询拦截单位的街面勤务人员 -->
	<select id="selectQwbb" parameterType="java.util.HashMap"
		resultType="com.cist.earlyewarningpost.model.Qw_report">
		select * from QW_REPORT t left join SYS_DEPART_INFO t1 on t.FK_DEPT_ID=t1.dept_pk
		<where>
		<if test="Pleasevalue !=null and Pleasevalue.size()>0">
		and t1.dept_code in
				<foreach collection="Pleasevalue" index="index" item="item"
					open="(" separator="," close=")">
					#{item}
				</foreach>
				</if>
		and t.REPORT_TYPE='1'
		and trunc(t.REPORT_PERIOD_TYPE)=trunc(sysdate)
		</where>
	</select>
	
		<!-- 通过布控卡口查询 关联车辆布控卡口 查询到布控卡口的关联设备-->
	<select id="selectBkDev" parameterType="java.util.HashMap"
		resultType="com.cist.earlyewarningpost.model.JcbkControlBayonet">
		
		select t.pk_id pk,t2.device_gb_serial,t2.device_gb_code,t2.device_gb_channel 
		from JCSJ_DEVICE t 
		left join JCBK_BAYONET_DEV t1 on t1.sbbh=t.pk_id
		left join JCBK_CONTROL_BAYONET t4 on t4.pk=t1.bkkk
		left join JCSJ_DEVICE_CAMERA_GB28181 t2 on  t2.DEVICE_ID=t.pk_id
		where t4.ENABLE ='1' and t4.kkbh = #{kkbh}
	</select>
	<!-- 查询配置国标视频地址 -->
	<select id="selectConfig" parameterType="java.util.HashMap" resultType="com.cist.earlyewarningpost.model.SysConfig">
	select * from SYS_CONFIG t 
	<where>
	syci_key = #{syci_key}
	</where>
	</select>
	
		<!-- 布控卡口的拦截区域 -->
	<select id="selectArea" parameterType="java.util.HashMap" resultType="com.cist.earlyewarningpost.model.JcbkFenceArea">
	select * from JCBK_FENCE_AREA t 
	<where>
	 exists (select * from JCBK_BAYONET_AREA t1 where t.pk=t1.qypk and t1.kkbh = #{kkbh})
	</where>
	</select>
</mapper>